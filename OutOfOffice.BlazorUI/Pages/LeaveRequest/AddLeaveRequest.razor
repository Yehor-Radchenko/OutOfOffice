@page "/leave-request/send"
@using OutOfOffice.BlazorUI.Components.Forms
@using OutOfOffice.BlazorUI.Pages.LeaveRequest.Models
@using OutOfOffice.BlazorUI.Services.Contracts
@using OutOfOffice.Common.Dto
@using OutOfOffice.Common.ViewModels.AbsenceReason
@inject ILeaveRequestService LeaveRequestService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Send Leave Request</PageTitle>

<MudText Typo="Typo.h4">Send Leave Request</MudText>
<br />

<LeaveRequestForm formModel="@formModel" OnValidSubmit="HandleValidSubmit" />

@code {
    LeaveRequestFormModel formModel = new LeaveRequestFormModel();
    LeaveRequestDto requestModel = new LeaveRequestDto();

    private async Task HandleValidSubmit()
    {
        if (formModel.DateRange is null)
        {
            this.Snackbar.Add($"Absence time span has to be specified.", Severity.Warning);
            return;
        }

        requestModel.AbsenceReasonId = formModel.AbsenceReasonId;
        requestModel.Comment = formModel.Comment;
        requestModel.Status = Common.Enums.RequestStatus.New;
        requestModel.StartDate = (DateTime)formModel.DateRange.Start;
        requestModel.EndDate = (DateTime)formModel.DateRange.End;

        try
        {
            await LeaveRequestService.AddLeaveRequest(requestModel);
            this.Snackbar.Add("Your request been sent successfully.", Severity.Success);
            NavigationManager.NavigateTo("/my-leave-requests");
        }
        catch (HttpRequestException ex)
        {
            this.Snackbar.Add($"Code: {ex.StatusCode}\n{ex.Message}", Severity.Error);
        }
    }
}
